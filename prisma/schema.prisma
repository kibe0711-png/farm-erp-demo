generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["driverAdapters"]
}

datasource db {
  provider = "postgresql"
}

model Farm {
  id              Int         @id @default(autoincrement())
  name            String      @unique @db.VarChar(100)
  laborRatePerDay Decimal?    @map("labor_rate_per_day") @db.Decimal(10, 2)
  createdAt       DateTime    @default(now()) @map("created_at")
  phases          FarmPhase[]
  users           User[]

  @@map("farms")
}

model FarmPhase {
  id         Int      @id @default(autoincrement())
  cropCode   String   @map("crop_code") @db.VarChar(50)
  phaseId    String   @map("phase_id") @db.VarChar(50)
  sowingDate DateTime @map("sowing_date") @db.Date
  farm       String   @db.VarChar(100)
  farmId     Int?     @map("farm_id")
  farmRef    Farm?    @relation(fields: [farmId], references: [id])
  areaHa     Decimal  @default(0) @map("area_ha") @db.Decimal(10, 4)
  archived   Boolean  @default(false)
  createdAt  DateTime @default(now()) @map("created_at")

  @@map("farm_phases")
}

model LaborSop {
  id               Int      @id @default(autoincrement())
  cropCode         String   @map("crop_code") @db.Text
  week             Int
  task             String   @db.Text
  noOfCasuals      Int      @map("no_of_casuals")
  costPerCasualDay Decimal  @map("cost_per_casual_day") @db.Decimal(10, 2)
  noOfDays         Int      @map("no_of_days")
  createdAt        DateTime @default(now()) @map("created_at")

  @@map("labor_sop")
}

model NutriSop {
  id               Int      @id @default(autoincrement())
  cropCode         String   @map("crop_code") @db.Text
  week             Int
  products         String   @db.Text
  activeIngredient String   @map("active_ingredient") @db.Text
  rateLitre        Decimal  @map("rate_litre") @db.Decimal(10, 4)
  rateHa           Decimal  @map("rate_ha") @db.Decimal(10, 4)
  unitPriceRwf     Decimal  @map("unit_price_rwf") @db.Decimal(12, 2)
  cost             Decimal  @db.Decimal(12, 2)
  createdAt        DateTime @default(now()) @map("created_at")

  @@map("nutri_sop")
}

model FeedingRecord {
  id              Int      @id @default(autoincrement())
  farmPhaseId     Int      @map("farm_phase_id")
  applicationDate DateTime @map("application_date") @db.Date
  product         String   @db.Text
  actualRateHa    Decimal  @map("actual_rate_ha") @db.Decimal(10, 4)
  actualQty       Decimal  @map("actual_qty") @db.Decimal(10, 4)
  notes           String?  @db.Text
  createdAt       DateTime @default(now()) @map("created_at")

  @@map("feeding_records")
}

model LaborLog {
  id          Int      @id @default(autoincrement())
  farmPhaseId Int      @map("farm_phase_id")
  logDate     DateTime @map("log_date") @db.Date
  task        String   @db.Text
  casuals     Int
  costPerDay  Decimal  @map("cost_per_day") @db.Decimal(10, 2)
  totalCost   Decimal  @map("total_cost") @db.Decimal(12, 2)
  notes       String?  @db.Text
  createdAt   DateTime @default(now()) @map("created_at")

  @@map("labor_logs")
}

model NutriSchedule {
  id            Int      @id @default(autoincrement())
  farmPhaseId   Int      @map("farm_phase_id")
  nutriSopId    Int      @map("nutri_sop_id")
  weekStartDate DateTime @map("week_start_date") @db.Date
  dayOfWeek     Int      @map("day_of_week")
  createdAt     DateTime @default(now()) @map("created_at")

  @@unique([farmPhaseId, nutriSopId, weekStartDate, dayOfWeek])
  @@map("nutri_schedules")
}

model LaborSchedule {
  id            Int      @id @default(autoincrement())
  farmPhaseId   Int      @map("farm_phase_id")
  laborSopId    Int      @map("labor_sop_id")
  weekStartDate DateTime @map("week_start_date") @db.Date
  dayOfWeek     Int      @map("day_of_week")
  createdAt     DateTime @default(now()) @map("created_at")

  @@unique([farmPhaseId, laborSopId, weekStartDate, dayOfWeek])
  @@map("labor_schedules")
}

model PhaseActivityOverride {
  id          Int      @id @default(autoincrement())
  farmPhaseId Int      @map("farm_phase_id")
  sopId       Int      @map("sop_id")
  sopType     String   @map("sop_type") @db.VarChar(10)
  action      String   @db.VarChar(10)
  weekStart   DateTime @map("week_start") @db.Date
  createdAt   DateTime @default(now()) @map("created_at")

  @@unique([farmPhaseId, sopId, sopType, weekStart])
  @@map("phase_activity_overrides")
}

model User {
  id              Int           @id @default(autoincrement())
  email           String        @unique @db.VarChar(255)
  name            String        @db.VarChar(100)
  password        String        @db.Text
  role            String        @default("FARM_CLERK") @db.VarChar(30)
  status          String        @default("ACTIVE") @db.VarChar(20)
  tokenVersion    Int           @default(0) @map("token_version")
  assignedFarmId  Int?          @map("assigned_farm_id")
  assignedFarm    Farm?         @relation(fields: [assignedFarmId], references: [id])
  sessions        UserSession[]
  createdAt       DateTime      @default(now()) @map("created_at")

  @@map("users")
}

model CropKeyInput {
  id             Int      @id @default(autoincrement())
  cropCode       String   @map("crop_code") @db.Text
  nurseryDays    Int      @map("nursery_days")
  outgrowingDays Int      @map("outgrowing_days")
  yieldPerHa     Decimal  @map("yield_per_ha") @db.Decimal(10, 2)
  harvestWeeks   Int      @map("harvest_weeks")
  rejectRate     Decimal  @map("reject_rate") @db.Decimal(5, 2)
  wk1            Decimal? @db.Decimal(10, 4)
  wk2            Decimal? @db.Decimal(10, 4)
  wk3            Decimal? @db.Decimal(10, 4)
  wk4            Decimal? @db.Decimal(10, 4)
  wk5            Decimal? @db.Decimal(10, 4)
  wk6            Decimal? @db.Decimal(10, 4)
  wk7            Decimal? @db.Decimal(10, 4)
  wk8            Decimal? @db.Decimal(10, 4)
  wk9            Decimal? @db.Decimal(10, 4)
  wk10           Decimal? @db.Decimal(10, 4)
  wk11           Decimal? @db.Decimal(10, 4)
  wk12           Decimal? @db.Decimal(10, 4)
  wk13           Decimal? @db.Decimal(10, 4)
  wk14           Decimal? @db.Decimal(10, 4)
  wk15           Decimal? @db.Decimal(10, 4)
  wk16           Decimal? @db.Decimal(10, 4)
  createdAt      DateTime @default(now()) @map("created_at")

  @@map("crop_key_inputs")
}

model HarvestSchedule {
  id            Int      @id @default(autoincrement())
  farmPhaseId   Int      @map("farm_phase_id")
  weekStartDate DateTime @map("week_start_date") @db.Date
  dayOfWeek     Int      @map("day_of_week")
  pledgeKg      Decimal? @map("pledge_kg") @db.Decimal(10, 2)
  createdAt     DateTime @default(now()) @map("created_at")

  @@unique([farmPhaseId, weekStartDate, dayOfWeek])
  @@map("harvest_schedules")
}

model HarvestLog {
  id          Int      @id @default(autoincrement())
  farmPhaseId Int      @map("farm_phase_id")
  logDate     DateTime @map("log_date") @db.Date
  actualKg    Decimal  @default(0) @map("actual_kg") @db.Decimal(10, 2)
  grade1Kg    Decimal  @default(0) @map("grade1_kg") @db.Decimal(10, 2)
  grade2Kg    Decimal  @default(0) @map("grade2_kg") @db.Decimal(10, 2)
  notes       String?  @db.Text
  createdAt   DateTime @default(now()) @map("created_at")

  @@map("harvest_logs")
}

model AnalyticsEvent {
  id        Int      @id @default(autoincrement())
  eventType String   @db.VarChar(50)
  eventName String   @db.VarChar(100)
  userId    Int?
  userRole  String?  @db.VarChar(30)
  metadata  Json?
  createdAt DateTime @default(now()) @map("created_at")

  @@index([userId, createdAt])
  @@index([eventType, createdAt])
  @@index([eventName, createdAt])
  @@map("analytics_events")
}

model ApiPerformanceLog {
  id           Int      @id @default(autoincrement())
  endpoint     String   @db.VarChar(200)
  method       String   @db.VarChar(10)
  statusCode   Int      @map("status_code")
  responseTime Int      @map("response_time")
  userId       Int?     @map("user_id")
  errorMessage String?  @map("error_message") @db.Text
  createdAt    DateTime @default(now()) @map("created_at")

  @@index([endpoint, createdAt])
  @@index([statusCode, createdAt])
  @@index([responseTime])
  @@map("api_performance_logs")
}

model UserSession {
  id        Int       @id @default(autoincrement())
  userId    Int       @map("user_id")
  user      User      @relation(fields: [userId], references: [id])
  loginAt   DateTime  @map("login_at")
  logoutAt  DateTime? @map("logout_at")
  duration  Int?
  ipAddress String?   @map("ip_address") @db.VarChar(50)
  userAgent String?   @map("user_agent") @db.Text

  @@index([userId, loginAt])
  @@map("user_sessions")
}
